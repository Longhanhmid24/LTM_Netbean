<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>üí¨ Chat Realtime (G·ª≠i file + Ti·∫øn tr√¨nh upload)</title>

  <!-- SockJS + STOMP -->
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

  <style>
    body { 
      font-family: Arial, sans-serif; 
      background: #f9f9f9; 
      padding: 20px;
    }

    h2 {
      color: #333;
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }

    h2::before {
      content: "üí¨";
      margin-right: 10px;
    }

    #chat-box {
      height: 380px;
      border: 1px solid #ddd;
      background: #fff;
      overflow-y: auto;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .msg-wrapper {
      display: flex;
      margin-bottom: 10px;
      clear: both;
    }

    .msg {
      padding: 10px 14px;
      border-radius: 15px;
      max-width: 70%;
      word-wrap: break-word;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .me-wrapper { justify-content: flex-end; }
    .me {
      background: #007bff;
      color: #fff;
      border-bottom-right-radius: 2px;
    }

    .other-wrapper { justify-content: flex-start; }
    .other {
      background: #f1f0f0;
      color: #000;
      border-bottom-left-radius: 2px;
    }

    #controls {
      display: flex;
      align-items: center;
      gap: 5px;
      margin-top: 10px;
    }

    input[type="text"] {
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    input[type="file"] { display: none; }

    label {
      background: #17a2b8;
      color: white;
      padding: 9px 15px;
      border-radius: 8px;
      cursor: pointer;
    }

    button {
      background: #007bff;
      color: white;
      padding: 9px 15px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
    }

    button:hover, label:hover {
      opacity: 0.9;
    }

    #progress-container {
      width: 100%;
      background: #e9ecef;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 10px;
      display: none;
    }

    #progress-bar {
      height: 8px;
      width: 0%;
      background: #007bff;
      transition: width 0.3s;
    }
  </style>
</head>
<body>
  <h2>Chat Realtime (c√≥ g·ª≠i file & ti·∫øn tr√¨nh)</h2>

  <div id="chat-box"></div>

  <div id="controls">
    <input id="message" type="text" placeholder="Nh·∫≠p tin nh·∫Øn..." onkeypress="if(event.key==='Enter') sendMessage()" />
    <label for="fileInput">üìé File</label>
    <input id="fileInput" type="file" onchange="uploadFile(event)" />
    <button onclick="sendMessage()">G·ª≠i</button>
  </div>

  <div id="progress-container">
    <div id="progress-bar"></div>
  </div>

<script>
  let stompClient = null;
  const serverIp = "10.15.4.231"; // üß† IP LAN c·ªßa m√°y th·∫≠t (server)
  const userId = Number(prompt("Nh·∫≠p ID c·ªßa b·∫°n (1 ho·∫∑c 2):"));
  const receiverId = userId === 1 ? 2 : 1;

  // ‚úÖ K·∫øt n·ªëi WebSocket
  function connect() {
    const socket = new SockJS(`http://${serverIp}:8080/ws`);
    stompClient = Stomp.over(socket);

    stompClient.connect({}, (frame) => {
      console.log("‚úÖ Connected:", frame);

      stompClient.subscribe(`/queue/messages/${userId}`, (message) => {
        const msg = JSON.parse(message.body);
        appendMessage(msg.senderId === userId ? "me" : "other", msg);
      });
    });
  }

  // ‚úÖ G·ª≠i tin nh·∫Øn text
  function sendMessage() {
    const content = document.getElementById("message").value.trim();
    if (!content) return;

    const msg = {
      senderId: userId,
      receiverId: receiverId,
      content: content,
      messageType: "text"
    };

    stompClient.send("/app/chat.send", {}, JSON.stringify(msg));
    appendMessage("me", msg);
    document.getElementById("message").value = "";
  }

  // ‚úÖ Upload file (·∫£nh, video, t√†i li·ªáu)
  async function uploadFile(event) {
    event.preventDefault();
    const file = event.target.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append("file", file);

    const progressBar = document.getElementById("progress-bar");
    const progressContainer = document.getElementById("progress-container");
    progressContainer.style.display = "block";

    try {
      const xhr = new XMLHttpRequest();
      xhr.open("POST", `http://${serverIp}:8080/api/upload`, true);

      xhr.upload.onprogress = (e) => {
        if (e.lengthComputable) {
          const percent = Math.round((e.loaded / e.total) * 100);
          progressBar.style.width = percent + "%";
        }
      };

      xhr.onload = () => {
        progressContainer.style.display = "none";
        progressBar.style.width = "0%";

        if (xhr.status === 200) {
          const res = JSON.parse(xhr.responseText); // üß† backend tr·∫£ JSON
          console.log("üìÅ Upload th√†nh c√¥ng:", res);

          const msg = {
            senderId: userId,
            receiverId: receiverId,
            messageType: res.fileType,
            mediaUrl: res.url,
            fileName: res.fileName
          };

          stompClient.send("/app/chat.send", {}, JSON.stringify(msg));
          appendMessage("me", msg);
        } else {
          alert("‚ùå L·ªói upload file!");
        }
      };

      xhr.onerror = () => {
        progressContainer.style.display = "none";
        alert("‚ùå Kh√¥ng th·ªÉ upload file!");
      };

      xhr.send(formData);
    } catch (err) {
      progressContainer.style.display = "none";
      console.error("L·ªói upload:", err);
      alert("‚ùå Upload th·∫•t b·∫°i!");
    }
  }

  // ‚úÖ X√°c ƒë·ªãnh lo·∫°i file
  function detectFileType(mime) {
    if (mime.startsWith("image/")) return "image";
    if (mime.startsWith("video/")) return "video";
    return "file";
  }

  // ‚úÖ Hi·ªÉn th·ªã tin nh·∫Øn ra m√†n h√¨nh
  function appendMessage(type, msg) {
    const chatBox = document.getElementById("chat-box");
    const wrapper = document.createElement("div");
    wrapper.classList.add("msg-wrapper", type === "me" ? "me-wrapper" : "other-wrapper");

    const msgDiv = document.createElement("div");
    msgDiv.classList.add("msg", type);

    if (msg.messageType === "text") {
      msgDiv.textContent = msg.content;
    } else if (msg.messageType === "image") {
      msgDiv.innerHTML = `<img src="${msg.mediaUrl}" width="220" style="border-radius:10px; max-width:100%;">`;
    } else if (msg.messageType === "video") {
      msgDiv.innerHTML = `<video controls width="250"><source src="${msg.mediaUrl}" type="video/mp4"></video>`;
    } else {
      msgDiv.innerHTML = `
        <a href="${msg.mediaUrl}" target="_blank"
           style="
             display:inline-block;
             text-decoration:none;
             font-weight:500;
             color:${type === "me" ? "#fff" : "#007bff"};
             background:${type === "me" ? "#0056b3" : "#e9ecef"};
             padding:8px 14px;
             border-radius:8px;
             box-shadow:0 1px 3px rgba(0,0,0,0.1);
           ">
           üìé ${msg.fileName}
        </a>`;
    }

    wrapper.appendChild(msgDiv);
    chatBox.appendChild(wrapper);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  // ‚úÖ T·∫£i l·∫°i l·ªãch s·ª≠ tin nh·∫Øn (n·∫øu backend c√≥ API)
  async function loadOldMessages() {
    try {
      const res = await fetch(`http://${serverIp}:8080/api/messages/${userId}/${receiverId}`);
      if (!res.ok) return;
      const messages = await res.json();

      messages.forEach(m => {
        appendMessage(
          m.sender_id === userId ? "me" : "other",
          {
            senderId: m.sender_id,
            receiverId: m.receiver_id,
            content: m.content,
            messageType: m.message_type,
            mediaUrl: m.media_url,
            fileName: m.file_name
          }
        );
      });
    } catch (e) {
      console.warn("Kh√¥ng t·∫£i ƒë∆∞·ª£c l·ªãch s·ª≠ tin nh·∫Øn:", e);
    }
  }

  connect();
  loadOldMessages();
</script>
</body>
</html>
